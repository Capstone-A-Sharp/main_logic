# 레포 설명
센서 정보를 바탕으로 pwm 제어 신호 송출하는 로직

---

## 📁 파일 설명 및 함수 목록

### 1. `main.py`
시스템의 메인 진입점이며 모든 모듈이 이곳에서 연결됩니다.

| 함수명               | 설명                                           | 용도                                |
|--------------------|----------------------------------------------|-------------------------------------|
| `update_wrapper()` | 센서 데이터를 순차적으로 읽고 상황에 맞는 처리 수행  | 메인 루프 함수 (제어 흐름의 중심)       |
| `handle_control()` | 압력 기반 속도 계산 및 이미지 업데이트            | 일반 제어 흐름                       |
| `handle_calibration()` | 사용자 압력 기준 보정 처리                    | 보정 모드 처리                        |


### 2. `control_logic.py`
보행기의 속도를 계산하고, PWM 신호를 시리얼로 전송하는 로직을 포함합니다.

| 함수/메서드명                 | 설명                                               | 용도                                  |
|-----------------------------|--------------------------------------------------|---------------------------------------|
| `SpeedController.__init__()`| 속도, 최대 속도, 보정 계수 초기화                         | 속도 컨트롤러 초기화                   |
| `update_threshold()`        | 기준 압력 설정                                      | 보정 후 기준값 반영                   |
| `compute_speed()`           | 현재 압력 상태에 따라 속도 계산 및 PWM 전송               | 제어 로직의 핵심                      |


### 3. `calibration.py`
사용자의 손 압력을 기준으로 보정값을 계산하는 모듈입니다.

| 함수/메서드명                   | 설명                                 | 용도                        |
|-------------------------------|------------------------------------|-----------------------------|
| `record_min_pressure()`       | 손을 가볍게 쥐었을 때의 압력 기록         | 기준 압력 하한 설정           |
| `record_max_pressure()`       | 강하게 쥐었을 때의 압력 기록             | 기준 압력 상한 설정           |
| `get_threshold()`             | 기준 압력값 계산 (최대 - 최소)            | 속도 비례 기준값 계산         |


### 4. `config.py`
시스템에서 공통으로 사용하는 상수들을 정의한 설정 파일입니다.

- `SERIAL_PORT_NANO`, `BAUD_RATE`, `NUM_ROWS`, `NUM_COLS`, `MAX_SPEED`, `ALPHA`, `BASE_PWM`


### 5. `serial_handler.py`
아두이노 나노와 시리얼 연결을 수행하는 단일 함수 정의 파일입니다.

| 함수명                | 설명                                | 용도              |
|---------------------|-----------------------------------|-------------------|
| `connect_arduino()` | 아두이노 나노와 시리얼 연결 초기화        | 하드웨어 연결       |


### 6. `serial_dispatcher.py`
시리얼 통신으로 수신된 센서 데이터를 분기 처리하는 파서입니다.

| 함수명                  | 설명                                          | 용도                      |
|-----------------------|---------------------------------------------|---------------------------|
| `parse_serial_line()` | PRESSURE, GYRO, SWITCH 등 라인을 context로 분기 처리 | 입력 해석 및 압력 행렬 처리 |


### 7. `pressure_reader.py`
압력 센서 2D 행렬을 필터링 및 증폭하고, 평균값을 계산합니다.

| 함수명                   | 설명                                          | 용도                   |
|------------------------|---------------------------------------------|------------------------|
| `apply_hpf()`          | 하이패스 필터를 통해 노이즈 제거                   | 압력 필터링               |
| `apply_avg_filter()`   | 각 행 평균을 계산하여 손가락/손바닥 분리 압력 확인     | 압력 분포 계산             |
| `process_pressure_sensor()` | 필터 → 제곱 → 정규화 → 평균 처리 전체 수행       | 센서 행렬 데이터 전처리       |


### 8. `visualizer.py`
matplotlib을 사용해 16x16 압력 데이터를 실시간 시각화합니다.

| 함수명                    | 설명                                            | 용도                |
|-------------------------|-----------------------------------------------|---------------------|
| `start_visualization()` | `FuncAnimation`을 사용해 주기적으로 `update_func()` 호출 | 메인 애니메이션 실행     |
| `update_image()`        | 이미지에 새로운 압력 데이터를 반영                   | 이미지 실시간 갱신       |


### 9. `test_main.py`
`main.py`와 동일한 흐름을 모킹된 시리얼 데이터로 수행해 테스트할 수 있도록 구성됨

- `get_mock_serial()`을 통해 테스트 환경 구성
- `reset_mock_read_data()`로 데이터 반복 테스트 가능

### 10. `test_serial_handler.py`

| 함수명                       | 설명                                           | 용도                       |
|----------------------------|----------------------------------------------|----------------------------|
| `create_test_sequence()`   | 반복 가능한 압력/센서 테스트 시퀀스 생성               | 테스트 입력 데이터 생성       |
| `get_mock_serial()`        | MagicMock으로 시리얼 포트 대신할 객체 생성            | 테스트용 시리얼 객체 생성      |
| `reset_mock_read_data()`   | 시퀀스를 초기화하여 무한 반복 가능하게 설정           | 테스트 반복 동작 유지          |


---

## 🔗 파일 간 연결 구조

```text
┌─────────────────────┐
│      main.py        │
└────────┬────────────┘
         │ uses
         ▼
  ┌────────────────────┐      ┌────────────────────┐
  │ serial_handler.py  │◄────►│ serial_dispatcher.py│
  └────────────────────┘      └────────┬────────────┘
                                       ▼
                           ┌──────────────────────┐
                           │ pressure_reader.py   │
                           └──────────────────────┘
         │                         ▲
         ▼                         │
  ┌────────────────────┐          │
  │ control_logic.py   │◄─────────┘
  └────────────────────┘
         │
         ▼
  ┌────────────────────┐
  │ calibration.py     │
  └────────────────────┘
         │
         ▼
  ┌────────────────────┐
  │ visualizer.py      │
  └────────────────────┘
         ▲
         │
  ┌────────────────────┐
  │ test_main.py       │── uses ──► test_serial_handler.py
  └────────────────────┘
```

---

## 📡 시리얼 통신 데이터 형식 (아두이노 나노 → PC)

시리얼로 들어오는 데이터는 다음 5가지 형식을 갖는다.

### 1. 압력 센서 데이터 (PRESSURE1 / PRESSURE2)
```
PRESSURE1
10,20,30,...(16개)
...
END
```
- 총 16줄의 16개 값 → 16x16 압력 행렬
- `END`가 나오면 데이터 완료 처리

### 2. 보정 스위치 입력
```
SWITCH_CALIB:1
```
- 1일 경우 보정 시작 (최대/최소 압력 기록)

### 3. 자이로 센서 데이터
```
GYRO:UP
GYRO:DOWN
GYRO:FLAT
```
- 오르막/내리막에 따라 `1.2x` 혹은 `0.8x` 보정 속도 적용

### 4. 방향 전환 스위치
```
SWITCH_DIR:1  → 전진
SWITCH_DIR:0  → 후진
```
- 모터 PWM 부호 결정

---

## ✅ 사용 방법 요약

1. **실행**: 아두이노 나노 연결 후 `main.py` 실행
```bash
python3 main.py
```

2. **테스트 실행 (모킹 환경)**:
```bash
python3 test_main.py
```